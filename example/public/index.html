<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SimpleWebAuthn Example</title>
</head>
<body>
<h1>SimpleWebAuthn Example</h1>

<h2>Register</h2>
<input type="text" id="register-username" placeholder="Username">
<button id="register-button">Register</button>

<h2>Login</h2>
<input type="text" id="login-username" placeholder="Username">
<button id="login-button">Login</button>

<script>
    async function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        bytes.forEach((b) => binary += String.fromCharCode(b));
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    async function base64urlToBuffer(baseurl) {
        const padding = '='.repeat((4 - baseurl.length % 4) % 4);
        const base64 = (baseurl + padding).replace(/-/g, '+').replace(/_/g, '/');
        const binary = atob(base64);
        const buffer = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            buffer[i] = binary.charCodeAt(i);
        }
        return buffer;
    }

    async function register() {
        const username = document.getElementById('register-username').value;
        if (!username) {
            alert('Please enter a username.');
            return;
        }

        const response = await fetch('/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username }),
        });

        const options = await response.json();

        // Convert ID and challenge from Base64URL to ArrayBuffer
        options.user.id = await base64urlToBuffer(options.user.id);
        options.challenge = await base64urlToBuffer(options.challenge);
        options.excludeCredentials = await Promise.all(
            options.excludeCredentials.map(async (cred) => ({
                ...cred,
                id: await base64urlToBuffer(cred.id),
            }))
        );

        try {
            const credential = await navigator.credentials.create({ publicKey: options });
            const attestationResponse = {
                username,
                response: {
                    id: await bufferToBase64url(credential.rawId),
                    type: credential.type,
                    response: {
                        authenticatorData: await bufferToBase64url(credential.response.authenticatorData),
                        clientDataJSON: await bufferToBase64url(credential.response.clientDataJSON),
                        signature: await bufferToBase64url(credential.response.signature),
                        userHandle: credential.response.userHandle ? await bufferToBase64url(credential.response.userHandle) : null,
                    },
                    transports: credential.response.transports || [],
                },
            };

            const verifyResponse = await fetch('/auth/register/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attestationResponse),
            });

            const verifyResult = await verifyResponse.json();
            if (verifyResult.verified) {
                alert('Registration successful!');
            } else {
                alert('Registration failed.');
            }
        } catch (error) {
            console.error(error);
            alert('Registration error.');
        }
    }

    async function login() {
        const username = document.getElementById('login-username').value;
        if (!username) {
            alert('Please enter a username.');
            return;
        }

        const response = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username }),
        });

        const options = await response.json();

        // Convert challenge and allowCredentials IDs from Base64URL to ArrayBuffer
        options.challenge = await base64urlToBuffer(options.challenge);
        options.allowCredentials = await Promise.all(
            options.allowCredentials.map(async (cred) => ({
                ...cred,
                id: await base64urlToBuffer(cred.id),
            }))
        );

        try {
            const assertion = await navigator.credentials.get({ publicKey: options });

            const assertionResponse = {
                id: await bufferToBase64url(assertion.rawId),
                type: assertion.type,
                response: {
                    authenticatorData: await bufferToBase64url(assertion.response.authenticatorData),
                    clientDataJSON: await bufferToBase64url(assertion.response.clientDataJSON),
                    signature: await bufferToBase64url(assertion.response.signature),
                    userHandle: assertion.response.userHandle ? await bufferToBase64url(assertion.response.userHandle) : null,
                },
            };

            const verifyResponse = await fetch('/auth/login/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(assertionResponse),
            });

            if (verifyResponse.ok) {
                alert('Authentication successful!');
            } else {
                alert('Authentication failed.');
            }
        } catch (error) {
            console.error(error);
            alert('Authentication error.');
        }
    }

    document.getElementById('register-button').addEventListener('click', register);
    document.getElementById('login-button').addEventListener('click', login);
</script>
</body>
</html>
