<!DOCTYPE html>
<html lang="en">
<head>
    <title>Login</title>
</head>
<body>
<h1>Login</h1>
<form id="login-form">
    <input type="text" id="username" name="username" placeholder="Enter Username" required>
    <button type="submit">Login</button>
</form>

<script>
    document.getElementById('login-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const username = document.getElementById('username').value;
        if (!username) return alert("Username is required!");

        try {
            // Step 1: Request login options from the server
            const optionsRes = await fetch('/login/options', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            const options = await optionsRes.json();

            // Step 2: Get credential for authentication
            const credential = await navigator.credentials.get({
                publicKey: options
            });

            // Step 3: Submit to Passport.js authentication
            const loginForm = document.createElement("form");
            loginForm.method = "POST";
            loginForm.action = "/login";

            const usernameInput = document.createElement("input");
            usernameInput.type = "hidden";
            usernameInput.name = "username";
            usernameInput.value = username;

            const credentialInput = document.createElement("input");
            credentialInput.type = "hidden";
            credentialInput.name = "response";
            credentialInput.value = JSON.stringify(credential);

            loginForm.appendChild(usernameInput);
            loginForm.appendChild(credentialInput);
            document.body.appendChild(loginForm);
            loginForm.submit();
        } catch (error) {
            console.error(error);
            alert("Login failed!");
        }
    });
</script>
</body>
</html>