<% layout('layout') -%>
<h1>Login</h1>
<form id="login-form">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" required />
    <button type="submit">Login</button>
</form>
<script>
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;

        // Step 1: Initiate Login and get assertion options
        const res1 = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username }),
        });

        if (!res1.ok) {
            const error = await res1.text();
            alert('Login failed: ' + error);
            return;
        }

        const options = await res1.json();

        // Step 2: Get Credential
        const credential = await navigator.credentials.get({
            publicKey: options,
        });

        // Convert ArrayBuffers to strings
        const authenticatorData = bufferToBase64Url(credential.response.authenticatorData);
        const clientDataJSON = bufferToBase64Url(credential.response.clientDataJSON);
        const signature = bufferToBase64Url(credential.response.signature);
        const userHandle = bufferToBase64Url(credential.response.userHandle);

        // Step 3: Send Assertion to Server
        const res2 = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                response: {
                    id: credential.id,
                    rawId: bufferToBase64Url(credential.rawId),
                    response: {
                        authenticatorData,
                        clientDataJSON,
                        signature,
                        userHandle,
                    },
                    type: credential.type,
                    // Include any extensions if used
                },
            }),
        });

        if (res2.ok) {
            window.location.href = '/dashboard';
        } else {
            const error = await res2.text();
            alert('Authentication failed: ' + error);
        }
    });

    function bufferToBase64Url(buffer) {
        return btoa(String.fromCharCode(...new Uint8Array(buffer)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
</script>